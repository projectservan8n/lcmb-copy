<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCMB Group - Material Order Request</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            line-height: 1.6;
            color: #1e293b;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .header p {
            font-size: 1.125rem;
            color: #64748b;
            font-weight: 400;
        }

        .loading-initial {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .form-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            padding: 40px;
            display: none;
        }

        .form-card.loaded {
            display: block;
        }

        .section {
            margin-bottom: 40px;
        }

        .section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-icon {
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: 600;
        }

        /* Category Selection */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .category-option {
            position: relative;
            cursor: pointer;
        }

        .category-option input {
            display: none;
        }

        .category-label {
            display: block;
            padding: 24px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            text-align: center;
            transition: all 0.2s ease;
            background: #ffffff;
            position: relative;
        }

        .category-label:hover {
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .category-option input:checked + .category-label {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25);
        }

        .category-emoji {
            font-size: 2rem;
            margin-bottom: 12px;
            display: block;
        }

        .category-name {
            font-weight: 600;
            font-size: 1rem;
        }

        /* Materials Section */
        .materials-section {
            display: none;
        }

        .materials-section.visible {
            display: block;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: white;
            font-family: 'Poppins', sans-serif;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .material-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .material-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .material-card.selected {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .material-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .material-checkbox {
            margin-right: 12px;
            margin-top: 4px;
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        .material-info {
            flex: 1;
        }

        .material-name {
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .material-price {
            font-weight: 700;
            color: #059669;
            font-size: 1rem;
        }

        .material-description {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .material-code {
            font-size: 0.75rem;
            color: #94a3b8;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .quantity-controls {
            display: none;
            align-items: center;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
            margin-top: 12px;
        }

        .quantity-controls.visible {
            display: flex;
        }

        .quantity-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .quantity-input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }

        .quantity-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .quantity-buttons {
            display: flex;
            gap: 4px;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .qty-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .unit-display {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .subtotal {
            font-size: 0.875rem;
            font-weight: 600;
            color: #059669;
            margin-left: auto;
        }

        /* Selected Materials Summary */
        .selected-materials {
            background: #f0f9ff;
            border: 2px solid #bae6fd;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            display: none;
        }

        .selected-materials.visible {
            display: block;
        }

        .summary-title {
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        .selected-items {
            margin-bottom: 16px;
        }

        .selected-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #bae6fd;
        }

        .selected-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            color: #374151;
        }

        .item-details {
            font-size: 0.875rem;
            color: #64748b;
        }

        .item-price {
            font-weight: 600;
            color: #059669;
        }

        .summary-totals {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            padding-top: 16px;
            border-top: 2px solid #bae6fd;
        }

        .total-item {
            text-align: center;
        }

        .total-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 4px;
        }

        .total-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0369a1;
        }

        /* Supplier Section */
        .supplier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .supplier-option {
            position: relative;
            cursor: pointer;
        }

        .supplier-option input {
            display: none;
        }

        .supplier-card {
            display: block;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            background: white;
            transition: all 0.2s ease;
        }

        .supplier-card:hover {
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .supplier-option input:checked + .supplier-card {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25);
        }

        .supplier-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .supplier-email {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .supplier-specialties {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Form Inputs */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: white;
            font-family: 'Poppins', sans-serif;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Submit Button */
        .submit-section {
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
            margin-top: 40px;
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }

        .submit-btn:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Messages */
        .message {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-weight: 500;
            display: none;
        }

        .message.success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .message.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        /* Loading States */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #64748b;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                padding: 32px 20px;
                margin-bottom: 24px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .form-card {
                padding: 24px;
            }
            
            .section {
                margin-bottom: 32px;
            }
            
            .category-grid,
            .supplier-grid {
                grid-template-columns: 1fr;
            }
            
            .materials-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .summary-totals {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.75rem;
            }
            
            .form-card {
                padding: 20px;
            }

            .summary-totals {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>LCMB Group</h1>
            <p>Material Order Request System</p>
        </div>
        
        <!-- Initial Loading State -->
        <div class="loading-initial" id="initialLoading">
            <div class="spinner"></div>
            <div class="loading-text">Loading materials and suppliers...</div>
        </div>
        
        <!-- Main Form Card -->
        <div class="form-card" id="formCard">
            <div class="message success" id="successMessage"></div>
            <div class="message error" id="errorMessage"></div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">Processing your request...</div>
            </div>
            
            <form id="materialOrderForm">
                <!-- Category Selection -->
                <div class="section">
                    <div class="section-title">
                        <div class="section-icon">1</div>
                        Select Service Category
                    </div>
                    <div class="category-grid" id="categoryGrid">
                        <!-- Categories will be loaded dynamically -->
                    </div>
                </div>

                <!-- Materials Selection -->
                <div class="section">
                    <div class="section-title">
                        <div class="section-icon">2</div>
                        Select Required Materials & Quantities
                    </div>
                    
                    <div class="materials-section" id="materialsSection">
                        <div class="search-container">
                            <input type="text" id="materialSearch" class="search-input" placeholder="Search materials...">
                        </div>
                        <div class="materials-grid" id="materialsGrid">
                            <!-- Materials will be loaded dynamically -->
                        </div>
                    </div>
                    
                    <div id="materialsPlaceholder" style="text-align: center; padding: 40px; color: #94a3b8; font-style: italic;">
                        Please select a service category first
                    </div>
                </div>

                <!-- Selected Materials Summary -->
                <div class="selected-materials" id="selectedMaterials">
                    <div class="summary-title">📋 Selected Materials</div>
                    <div class="selected-items" id="selectedItems">
                        <!-- Selected items will be populated here -->
                    </div>
                    <div class="summary-totals">
                        <div class="total-item">
                            <div class="total-label">Items</div>
                            <div class="total-value" id="totalItems">0</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">Quantity</div>
                            <div class="total-value" id="totalQuantity">0</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">Total Price</div>
                            <div class="total-value" id="totalPrice">$0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Supplier Selection -->
                <div class="section">
                    <div class="section-title">
                        <div class="section-icon">3</div>
                        Choose Supplier
                    </div>
                    <div class="supplier-grid" id="supplierGrid">
                        <!-- Suppliers will be loaded dynamically -->
                    </div>
                </div>

                <!-- User Information -->
                <div class="section">
                    <div class="section-title">
                        <div class="section-icon">4</div>
                        Your Information & Order Details
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userName" class="form-label">Full Name</label>
                            <input type="text" id="userName" name="user_name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="userEmail" class="form-label">Email Address</label>
                            <input type="email" id="userEmail" name="user_email" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="urgency" class="form-label">Urgency Level</label>
                            <select id="urgency" name="urgency" class="form-select">
                                <option value="Normal">Normal (3-5 days)</option>
                                <option value="High">High (1-2 days)</option>
                                <option value="Urgent">Urgent (Same day)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projectRef" class="form-label">Project Reference (Optional)</label>
                            <input type="text" id="projectRef" name="project_ref" class="form-input" placeholder="Job #, Site name, etc.">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes" class="form-label">Additional Notes (Optional)</label>
                        <textarea id="notes" name="notes" class="form-textarea" placeholder="Any special requirements, delivery instructions, or additional details..."></textarea>
                    </div>
                </div>

                <div class="submit-section">
                    <button type="submit" class="submit-btn" id="submitBtn">
                        Submit Material Order Request
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ✅ UPDATED WITH YOUR RAILWAY WEBHOOK URLS ✅
        const MATERIALS_ENDPOINT = 'https://primary-s0q-production.up.railway.app/webhook/materials-data';
        const ORDER_ENDPOINT = 'https://primary-s0q-production.up.railway.app/webhook/material-order';

        // Global data storage
        let materialsData = {};
        let suppliersData = [];
        let selectedMaterials = [];
        let allMaterials = [];

        // DOM elements
        const initialLoading = document.getElementById('initialLoading');
        const formCard = document.getElementById('formCard');
        const categoryGrid = document.getElementById('categoryGrid');
        const materialsSection = document.getElementById('materialsSection');
        const materialsPlaceholder = document.getElementById('materialsPlaceholder');
        const materialsGrid = document.getElementById('materialsGrid');
        const materialSearch = document.getElementById('materialSearch');
        const selectedMaterialsSection = document.getElementById('selectedMaterials');
        const selectedItems = document.getElementById('selectedItems');
        const supplierGrid = document.getElementById('supplierGrid');
        const form = document.getElementById('materialOrderForm');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const loading = document.getElementById('loading');
        const submitBtn = document.getElementById('submitBtn');

        // Category icons mapping
        const categoryIcons = {
            'AC Install': '❄️',
            'AC Service': '🔧',
            'Electrical': '⚡',
            'Factory Stock': '📦',
            'default': '📋'
        };

        // Initialize the application
        async function initializeApp() {
            try {
                await loadMaterialsAndSuppliers();
                populateCategories();
                populateSuppliers();
                setupEventListeners();
                
                initialLoading.style.display = 'none';
                formCard.classList.add('loaded');
            } catch (error) {
                console.error('Failed to initialize app:', error);
                showError('Failed to load materials and suppliers. Please check your n8n webhooks and try again.');
                initialLoading.style.display = 'none';
            }
        }

        // Load materials and suppliers from n8n webhooks
        async function loadMaterialsAndSuppliers() {
            try {
                const response = await fetch(MATERIALS_ENDPOINT);
                if (!response.ok) {
                    throw new Error('Failed to fetch materials data');
                }
                const data = await response.json();
                materialsData = data.data.materials;
                suppliersData = data.data.suppliers;
            } catch (error) {
                console.error('API Error:', error);
                // Fallback to mock data for demo
                materialsData = {
                    'AC Install': [
                        { name: 'Split System Unit 2.5kW', unit: 'pcs', price: 899.00, description: 'Energy efficient cooling unit', code: 'AC-SS-25' },
                        { name: 'Copper Refrigerant Line Set 5m', unit: 'pcs', price: 125.00, description: 'Pre-insulated copper lines', code: 'AC-CRL-5M' },
                        { name: 'Wall Mounting Bracket Heavy Duty', unit: 'pcs', price: 45.00, description: 'Heavy duty wall mount', code: 'AC-WMB-HD' }
                    ],
                    'AC Service': [
                        { name: 'R410A Refrigerant Gas', unit: 'kg', price: 28.00, description: 'Eco-friendly refrigerant', code: 'AC-R410A' },
                        { name: 'Air Filter Standard', unit: 'pcs', price: 15.00, description: 'Washable air filter', code: 'AC-FLT-STD' },
                        { name: 'Coil Cleaning Solution', unit: 'liters', price: 18.00, description: 'Professional cleaning solution', code: 'AC-CLN-COIL' }
                    ],
                    'Electrical': [
                        { name: 'Circuit Breaker 20A', unit: 'pcs', price: 25.00, description: 'Single pole circuit breaker', code: 'EL-CB-20A' },
                        { name: 'Power Point Double GPO White', unit: 'pcs', price: 8.50, description: 'Standard power outlet', code: 'EL-PP-DBL-WHT' },
                        { name: 'LED Downlight 10W', unit: 'pcs', price: 15.00, description: 'Warm white LED light', code: 'EL-LED-10W' }
                    ],
                    'Factory Stock': [
                        { name: 'Safety Helmet White', unit: 'pcs', price: 18.00, description: 'Hard hat safety helmet', code: 'FS-HAT-WHT' },
                        { name: 'Safety Vest Hi-Vis Orange', unit: 'pcs', price: 12.00, description: 'High visibility vest', code: 'FS-VST-HIVO' },
                        { name: 'Work Gloves Leather', unit: 'pcs', price: 15.00, description: 'Leather work gloves', code: 'FS-GLV-LTHR' }
                    ]
                };

                suppliersData = [
                    { id: 'supplier1', name: 'ElectroSupply Co.', email: 'orders@electrosupply.com.au', specialties: ['Electrical', 'AC Install'] },
                    { id: 'supplier2', name: 'AC Parts Direct', email: 'sales@acpartsdirect.com.au', specialties: ['AC Install', 'AC Service'] },
                    { id: 'supplier3', name: 'Trade Materials Plus', email: 'sales@tradematerials.com.au', specialties: ['Electrical', 'Factory Stock'] }
                ];
            }
        }

        // Populate categories
        function populateCategories() {
            const categories = Object.keys(materialsData);
            categoryGrid.innerHTML = '';

            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-option';
                categoryDiv.innerHTML = `
                    <input type="radio" name="category" value="${category}" id="category-${category.replace(/\s+/g, '-')}">
                    <label for="category-${category.replace(/\s+/g, '-')}" class="category-label">
                        <span class="category-emoji">${categoryIcons[category] || categoryIcons.default}</span>
                        <div class="category-name">${category}</div>
                    </label>
                `;
                categoryGrid.appendChild(categoryDiv);
            });
        }

        // Populate suppliers
        function populateSuppliers() {
            supplierGrid.innerHTML = '';

            suppliersData.forEach(supplier => {
                const supplierDiv = document.createElement('div');
                supplierDiv.className = 'supplier-option';
                supplierDiv.innerHTML = `
                    <input type="radio" name="supplier" value="${supplier.id}" id="supplier-${supplier.id}">
                    <label for="supplier-${supplier.id}" class="supplier-card">
                        <div class="supplier-name">${supplier.name}</div>
                        <div class="supplier-email">${supplier.email}</div>
                        <div class="supplier-specialties">Specializes in: ${supplier.specialties.join(', ')}</div>
                    </label>
                `;
                supplierGrid.appendChild(supplierDiv);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Category change handler
            document.querySelectorAll('input[name="category"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        populateMaterials(this.value);
                        materialsPlaceholder.style.display = 'none';
                        materialsSection.classList.add('visible');
                    }
                });
            });

            // Material search handler
            materialSearch.addEventListener('input', function() {
                filterMaterials(this.value);
            });

            // Form submission handler
            form.addEventListener('submit', handleFormSubmission);
        }

        // Populate materials based on category
        function populateMaterials(category) {
            const materials = materialsData[category] || [];
            allMaterials = materials;
            selectedMaterials = []; // Reset selected materials
            
            renderMaterials(materials);
            updateSelectedMaterialsDisplay();
        }

        // Render materials in the grid
        function renderMaterials(materials) {
            materialsGrid.innerHTML = '';
            
            materials.forEach((material, index) => {
                const materialCard = document.createElement('div');
                materialCard.className = 'material-card';
                materialCard.innerHTML = `
                    <div class="material-header">
                        <input type="checkbox" class="material-checkbox" data-material-index="${index}">
                        <div class="material-info">
                            <div class="material-name">${material.name}</div>
                            <div class="material-price">$${material.price.toFixed(2)}/${material.unit}</div>
                        </div>
                    </div>
                    ${material.description ? `<div class="material-description">${material.description}</div>` : ''}
                    <div class="material-code">${material.code}</div>
                    <div class="quantity-controls">
                        <span class="quantity-label">Qty:</span>
                        <div class="quantity-buttons">
                            <button type="button" class="qty-btn" data-action="decrease">−</button>
                            <input type="number" class="quantity-input" min="1" value="1" data-material-index="${index}">
                            <button type="button" class="qty-btn" data-action="increase">+</button>
                        </div>
                        <span class="unit-display">${material.unit}</span>
                        <span class="subtotal">$${material.price.toFixed(2)}</span>
                    </div>
                `;
                
                // Add event listeners
                const checkbox = materialCard.querySelector('.material-checkbox');
                const quantityControls = materialCard.querySelector('.quantity-controls');
                const quantityInput = materialCard.querySelector('.quantity-input');
                const subtotalSpan = materialCard.querySelector('.subtotal');
                const decreaseBtn = materialCard.querySelector('[data-action="decrease"]');
                const increaseBtn = materialCard.querySelector('[data-action="increase"]');

                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        materialCard.classList.add('selected');
                        quantityControls.classList.add('visible');
                        addToSelectedMaterials(material, index, 1);
                    } else {
                        materialCard.classList.remove('selected');
                        quantityControls.classList.remove('visible');
                        removeFromSelectedMaterials(index);
                    }
                });

                quantityInput.addEventListener('input', function() {
                    const quantity = parseInt(this.value) || 1;
                    const subtotal = material.price * quantity;
                    subtotalSpan.textContent = `$${subtotal.toFixed(2)}`;
                    updateSelectedMaterialQuantity(index, quantity);
                });

                decreaseBtn.addEventListener('click', function() {
                    let quantity = parseInt(quantityInput.value) || 1;
                    if (quantity > 1) {
                        quantity--;
                        quantityInput.value = quantity;
                        quantityInput.dispatchEvent(new Event('input'));
                    }
                });

                increaseBtn.addEventListener('click', function() {
                    let quantity = parseInt(quantityInput.value) || 1;
                    quantity++;
                    quantityInput.value = quantity;
                    quantityInput.dispatchEvent(new Event('input'));
                });
                
                materialsGrid.appendChild(materialCard);
            });
        }

        // Filter materials based on search
        function filterMaterials(searchTerm) {
            if (!allMaterials.length) return;
            
            const filtered = allMaterials.filter(material => 
                material.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                material.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                material.code.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            renderMaterials(filtered);
        }

        // Add material to selected list
        function addToSelectedMaterials(material, index, quantity) {
            const selectedMaterial = {
                ...material,
                index: index,
                quantity: quantity
            };
            selectedMaterials.push(selectedMaterial);
            updateSelectedMaterialsDisplay();
        }

        // Remove material from selected list
        function removeFromSelectedMaterials(index) {
            selectedMaterials = selectedMaterials.filter(item => item.index !== index);
            updateSelectedMaterialsDisplay();
        }

        // Update quantity of selected material
        function updateSelectedMaterialQuantity(index, quantity) {
            const material = selectedMaterials.find(item => item.index === index);
            if (material) {
                material.quantity = quantity;
                updateSelectedMaterialsDisplay();
            }
        }

        // Update selected materials display
        function updateSelectedMaterialsDisplay() {
            if (selectedMaterials.length === 0) {
                selectedMaterialsSection.classList.remove('visible');
                return;
            }

            selectedMaterialsSection.classList.add('visible');
            
            // Update items list
            selectedItems.innerHTML = selectedMaterials.map(item => `
                <div class="selected-item">
                    <div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-details">${item.quantity} ${item.unit} × $${item.price.toFixed(2)}</div>
                    </div>
                    <div class="item-price">$${(item.quantity * item.price).toFixed(2)}</div>
                </div>
            `).join('');

            // Update totals
            const totalItems = selectedMaterials.length;
            const totalQuantity = selectedMaterials.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = selectedMaterials.reduce((sum, item) => sum + (item.quantity * item.price), 0);

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalPrice').textContent = `$${totalPrice.toFixed(2)}`;
        }

        // Handle form submission
        async function handleFormSubmission(e) {
            e.preventDefault();
            
            hideMessages();
            showLoading(true);
            
            const formData = new FormData(form);
            const selectedSupplier = document.querySelector('input[name="supplier"]:checked');
            const supplierInfo = selectedSupplier ? suppliersData.find(s => s.id === selectedSupplier.value) : null;
            
            const orderData = {
                category: formData.get('category'),
                materials: selectedMaterials.map(item => ({
                    name: item.name,
                    quantity: item.quantity,
                    unit: item.unit,
                    price: item.price,
                    code: item.code
                })),
                supplier_name: supplierInfo ? supplierInfo.name : '',
                supplier_email: supplierInfo ? supplierInfo.email : '',
                user_name: formData.get('user_name'),
                user_email: formData.get('user_email'),
                urgency: formData.get('urgency') || 'Normal',
                project_ref: formData.get('project_ref') || '',
                notes: formData.get('notes') || ''
            };

            // Validate required fields
            if (!orderData.category || selectedMaterials.length === 0 || !orderData.supplier_email || !orderData.user_name || !orderData.user_email) {
                showError('Please complete all required fields before submitting.');
                showLoading(false);
                return;
            }

            try {
                const response = await fetch(ORDER_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit order');
                }

                const result = await response.json();
                
                const totalPrice = selectedMaterials.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                showSuccess(`Order submitted successfully! 
                
Order ID: ${result.order_id}
Total: $${totalPrice.toFixed(2)}

The supplier will be contacted and you'll receive a confirmation email shortly.`);
                
                // Reset form
                form.reset();
                selectedMaterials = [];
                updateSelectedMaterialsDisplay();
                materialsSection.classList.remove('visible');
                materialsPlaceholder.style.display = 'block';
                
            } catch (error) {
                showError('Failed to submit order. Please try again or contact support.');
                console.error('Submission error:', error);
            } finally {
                showLoading(false);
            }
        }

        // Utility functions
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            scrollToTop();
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            scrollToTop();
        }

        function hideMessages() {
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
        }

        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
            submitBtn.disabled = show;
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
